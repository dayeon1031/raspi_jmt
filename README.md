# 🚗 차찾GO  
**UWB 기반 주차차량 찾기 서비스**

---

## 📄 개요  

### ▪️ 개발개요  
- **팀명**: 차찾GO  
- **작품명**: UWB 기반 주차차량 찾기 서비스  
- **작품설명**:  
  - UWB 기술을 이용하여 주차장의 차량 위치를 정밀하게 추적하여 사용자에게 앱을 통해 제공하는 시스템.  
  - 주차 가능한 위치 추천 기능 및 사전정산 기능 지원.  

---

### ▪️ 개발 목적 및 목표  
1. **정밀한 차량 위치 추적 시스템 개발**  
   - UWB(초광대역) 기술을 활용하여 복잡한 주차 환경에서도 신뢰할 수 있는 위치 정보 제공.  
2. **사용자 친화적인 모바일 애플리케이션 구현**  
   - Android Studio를 통해 직관적이고 간편한 UI/UX를 제공하는 앱 개발.  
   - 차량 실시간 위치 확인, 주차 요금 정산, 차량 입출차 정보 확인 등의 기능 제공.  
3. **서버-클라이언트 구조 기반의 실시간 데이터 처리**  
   - Flask 백엔드 서버 구축으로 차량 정보 및 요금을 실시간으로 처리.  
   - RESTful API를 사용해 데이터 통신과 실시간 업데이트 지원.  

---

### ▪️ 개발 배경 및 동기  
대형 백화점 지하주차장의 규모가 커짐에 따라 GPS 기반 위치 추적의 한계로 인해 차량 찾기가 어려워지고 있음.  
- **UWB 기술**은 GPS보다 실내에서의 정확도가 높아 차량 위치를 정밀히 추적할 수 있음.  
- 장애물에 강하고 신호 방해가 적어 지하 주차장에서 효율적으로 사용 가능.  
- 이를 활용해 사용자 경험을 개선하고, 실내 네비게이션 시스템으로도 확장 가능성을 지님.  

---

### ▪️ 개발 환경 설명  

#### 1. HW 구성 및 기능
- **라즈베리파이**: 주차 위치 데이터를 수집 및 처리하며, 메인 컨트롤러 역할 수행.  
- **Crowtail-DWM1000 UWB 모듈**: UWB 기술로 앵커와의 거리 데이터를 제공하며 ±10cm 정확도 제공.  
- **앵커 구성**: 4개의 앵커를 사각형으로 배치하여 거리 데이터 수집 및 위치 추적 안정성 확보.  
- **추가 하드웨어**:  
  - 버튼: 주차 상태 전환.  
  - LED: 현재 주차 상태를 시각적으로 표시.  
  - 서보모터: 차단봉의 열림/닫힘 동작 수행.  

#### 2. SW 구성 및 기능
- **Flask 서버**: 차량 입출차 기록, 주차 요금, 위치 정보를 관리.  
- **MySQL 데이터베이스**: 주차 기록, 차량 선호도, 주차 공간 상태 등을 저장.  

---

### ▪️ 시스템 동작 개요  
1. 라즈베리파이가 태그와 앵커 간 거리 데이터를 수집.  
2. 수집된 거리 데이터를 삼변측량을 통해 현재 좌표(x, y)로 계산.  
3. 계산된 좌표가 특정 주차 공간에 속하는지 확인.  
4. 안정적으로 위치가 확인되면 데이터베이스에 주차 상태와 위치를 업데이트.  
5. 버튼 입력으로 `주차 상태 ↔ 운전 상태`를 전환.  

---

### ▪️ 문제 해결 과정  
1. **앵커 부족 문제**  
   - 기존 3개 앵커에서 4개로 확장하여 초과 정의 문제 해결.  
   - 사각형 모양으로 앵커를 배치해 위치 계산 안정성 향상.  

2. **위치 오차와 데이터 안정성 문제**  
   - 동일한 주차 구역이 여러 번 연속 검출될 경우에만 위치를 갱신하여 오차 최소화.  
   - 노이즈 제거 및 거리 데이터를 평균화하여 신뢰도를 높임.  

---

## API 기능 요약

### 1. 차량 번호 입력 기능 (`/vehicle`)
- **이벤트**: 사용자가 웹 페이지에서 차량 번호를 입력하면 POST 요청 발생.
- **SQL 테이블**: `ParkingLog`, `ParkingPreference`
- **작업**:
  - 입력된 차량 번호를 `session`에 저장.
  - `ParkingLog`와 `ParkingPreference` 테이블에 해당 차량 번호(`id` 열)를 추가.  
    *(중복 방지를 위해 `INSERT IGNORE` 사용)*

---

### 2. 선호 자리 설정 (`/settings`)
- **이벤트**: 사용자가 주차 선호 옵션(출구 근처, 입구 근처, 가까운 자리)을 선택하고 제출.
- **SQL 테이블**: `ParkingPreference`
- **작업**:
  - `POST` 요청으로 전달된 선호 옵션(`near_exit`, `near_entrance`, `nearest`)을 `ParkingPreference` 테이블의 해당 `id`에 업데이트.

---

### 3. 입차 및 출차 처리 (`/barrier`)
- **이벤트**: 차량이 입차 또는 출차할 때 차단기 제어 이벤트 발생.
- **SQL 테이블**: `ParkingLog`
- **작업**:
  - **입차 (entry)**:
    - `ParkingLog` 테이블에서 차량 번호와 `entry_time` 값이 있는 경우, `drive` 값을 `1`로 설정.
    - 성공 시 `{"message": "입차 기록 완료", "status": "entry"}` 반환.
  - **출차 (exit)**:
    - `ParkingLog` 테이블에서 차량 번호에 대해 `drive` 값을 `NULL`로 설정.
    - 성공 시 `{"message": "출차 기록 완료", "status": "exit"}` 반환.

---

### 4. 추천 위치 제공 (`/recommendation`)
- **이벤트**: 사용자가 추천 주차 위치를 요청.
- **SQL 테이블**: `ParkingLog`, `ParkingSlot`, `ParkingPreference`
- **작업**:
  - `ParkingLog` 테이블에서 `entry_time` 확인. 없으면 추천 위치 제공 불가.
  - `ParkingPreference` 테이블에서 사용자의 선호도(`near_exit`, `near_entrance`, `nearest`)를 가져와 자리 우선순위 설정.
  - `ParkingSlot` 테이블에서 빈 자리(`occupied = 0`)를 검색하여 추천.
  - 추천된 자리를 `ParkingLog`의 `parking_location`에 업데이트.

---

### 5. 주차 위치 확인 (`/parking`)
- **이벤트**: 사용자가 현재 주차 위치 확인.
- **SQL 테이블**: `ParkingLog`
- **작업**:
  - `ParkingLog` 테이블에서 차량 번호에 대한 `parking_location`과 `drive` 값을 가져옴.
  - `parking_location`과 함께 사용자에게 반환.

---

### 6. 정산 처리 (`/payment`)
- **이벤트**: 사용자가 정산 버튼 클릭.
- **SQL 테이블**: `ParkingLog`
- **작업**:
  - `ParkingLog` 테이블에서 차량 번호의 `entry_time`을 가져와 주차 시간을 계산.
  - 정산 완료 시 `payment` 값을 `1`로 업데이트.

---

### 7. 지도 표시 (`/map`)
- **이벤트**: 사용자가 주차 위치를 지도에 표시.
- **SQL 테이블**: `ParkingLog`
- **작업**:
  - `ParkingLog` 테이블에서 차량 번호의 `parking_location` 값을 가져옴.
  - `parking_location` 값을 바탕으로 적절한 이미지 경로 설정.

---

### 8. 메인 페이지 (`/`)
- **이벤트**: 사용자가 웹 사이트 접속.
- **SQL 테이블**: `ParkingLog`
- **작업**:
  - `ParkingLog` 테이블에서 차량 번호의 최신 `parking_location`, `drive`, `entry_time` 값을 가져옴.
  - 데이터에 따라 메인 페이지를 구성.

---

### 9. 번호판 인식 이벤트 (카메라 번호판 인식 코드)
- **이벤트**: 카메라가 차량 번호 인식.
- **SQL 테이블**: `ParkingLog`
- **작업**:
  - 인식된 번호판이 `ParkingLog` 테이블의 `id`와 일치하는지 확인.
  - `payment` 값이 `1`이면 아두이노에 신호 전송. `0`이면 신호를 보내지 않음.

---
### ▪️ 데이터베이스 구조
1. **ParkingLog**  
   - 차량 번호, 움직임 상태, 입차 시간, 주차 위치, 정산 상태 관리.  
2. **ParkingPreference**  
   - 차량 선호도 정보(출구 근처, 입구 근처, 가까운 자리) 저장.  
3. **ParkingSlot**  
   - 주차 공간 번호와 점유 상태 관리.
---
## SQL 테이블 요약

### `ParkingLog`
| 열 이름            | 설명                       |
|--------------------|----------------------------|
| `id`              | 차량 번호                 |
| `drive`           | 움직임 상태: `1`/`0`      |
| `entry_time`      | 입차 시간                 |
| `parking_location`| 추천된 주차 자리          |
| `payment`         | 정산 상태: `1`/`0`        |

### `ParkingPreference`
| 열 이름          | 설명                       |
|------------------|----------------------------|
| `id`            | 차량 번호                 |
| `near_exit`     | 출구 근처 선호 여부       |
| `near_entrance` | 입구 근처 선호 여부       |
| `nearest`       | 가까운 자리 선호 여부     |

### `ParkingSlot`
| 열 이름        | 설명                       |
|----------------|----------------------------|
| `slot_number` | 주차 자리 번호             |
| `occupied`    | 점유 여부: `1`/`0`         |

---

## 주요 흐름 요약
1. **차량 번호 입력** → **선호 설정** → **입차** → **추천 자리 확인** → **주차 완료** → **정산** → **출차**

각 단계에서 SQL 테이블과의 상호작용이 이루어지며, 상태에 따라 웹 페이지가 동적으로 변경됩니다.
